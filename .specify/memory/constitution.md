<!--
=============================================================================
SYNC IMPACT REPORT
=============================================================================
Version change: N/A (initial) → 1.0.0

Created sections:
  - Core Principles (5 principles)
  - Technology Stack Requirements
  - Development Workflow & Quality Gates
  - Governance

Templates requiring updates:
  - .specify/templates/plan-template.md ✅ (no changes needed - generic template)
  - .specify/templates/spec-template.md ✅ (no changes needed - generic template)
  - .specify/templates/tasks-template.md ✅ (no changes needed - generic template)

Follow-up TODOs: None

Rationale: Initial constitution derived from CLAUDE.md, README.md, and
established project architecture patterns.
=============================================================================
-->

# MediSync Constitution

## Core Principles

### I. Security First & HITL Gates (NON-NEGOTIABLE)

Security is paramount in healthcare and financial systems. All features MUST be designed with
security as the primary concern, not as an afterthought.

**Rules:**
- All AI agents MUST connect to the data warehouse using the `medisync_readonly` database role
- All SQL queries generated by AI MUST be validated as SELECT-only before execution
- No AI agent can autonomously push data to Tally ERP — explicit human approval is REQUIRED
- Self-approval is blocked by OPA policy — the same user cannot submit and approve
- Column-level data masking MUST be applied based on user role (PII, cost prices)
- All external API calls MUST use TLS 1.3+
- Sensitive configuration MUST be via environment variables, never hardcoded

**Rationale:** Healthcare data is sensitive and financial data requires audit trails.
HITL (Human-in-the-Loop) gates prevent AI hallucinations from corrupting production data.

### II. Read-Only Intelligence Plane

The AI orchestration layer operates on a strict read-only basis against the data warehouse.

**Rules:**
- AI agents execute queries via `medisync_readonly` role with GRANT SELECT only
- OPA policies MUST block all DML operations at the driver level for AI agents
- Write operations are ONLY permitted in the Action Plane (Tally sync) with human approval
- The data warehouse is NEVER directly modified by AI agents

**Rationale:** Prevents accidental or malicious data corruption from AI hallucinations.
Structural writes are impossible at the database driver level.

### III. i18n by Default

Every feature MUST work in both English (LTR) and Arabic (RTL) from day one.

**Rules:**
- All user-facing strings MUST use i18next (web) or ARB files (mobile) — no hardcoded text
- Web UI MUST use Tailwind logical properties (`ms-`, `me-`, `ps-`, `pe-`) for RTL support
- AI responses MUST include `ResponseLanguageInstruction` in every Genkit flow
- CI MUST block merges on translation gaps between EN and AR
- Date, number, and currency formatting MUST use locale-aware APIs

**Rationale:** Retroactively adding i18n is costly and error-prone. Building it from
Phase 1 ensures the platform serves Arabic-speaking healthcare markets properly.

### IV. Open Source Only

Every component of the MediSync platform MUST use an OSI-approved license.

**Rules:**
- All dependencies MUST be verified against the approved license list
- No GPL/AGPL components in production (only Apache-2.0, MIT, BSD-3, PostgreSQL license)
- License verification is part of the PR review checklist
- See `docs/agents/01-oss-toolchain.md` for the complete approved stack

**Rationale:** Enables deployment in regulated healthcare environments without legal
complications. Allows on-premises deployment for clients with data sovereignty requirements.

### V. Test-Driven Development

Tests MUST be written before implementation for all non-trivial code.

**Rules:**
- Unit tests are REQUIRED for all business logic (Go: `testing` + `testify`, React: Vitest)
- Integration tests are REQUIRED for ETL pipelines, agent flows, and OPA policies
- End-to-end tests are REQUIRED for critical user journeys (query flow, document-to-Tally)
- Mock external dependencies (Tally, HIMS, LLMs) for reliable unit tests
- All tests MUST pass before merge to main

**Rationale:** Healthcare and financial systems demand reliability. TDD catches bugs early
and ensures confidence in refactoring. Tests serve as living documentation.

## Technology Stack Requirements

### Backend Stack

| Component | Technology | License |
|-----------|------------|---------|
| Language | Go 1.26 | BSD-3 |
| HTTP Router | go-chi/chi | MIT |
| Message Broker | NATS / JetStream | Apache-2.0 |
| Identity | Keycloak | Apache-2.0 |
| Authorization | Open Policy Agent (OPA) | Apache-2.0 |
| Database | PostgreSQL 18.2 + pgvector | PostgreSQL |
| Cache | Redis | BSD-3 |

### AI & ML Stack

| Component | Technology | License |
|-----------|------------|---------|
| Flow Orchestration | Google Genkit | Apache-2.0 |
| Multi-agent Framework | Agent ADK | Apache-2.0 |
| Inter-agent Protocol | Google A2A Protocol | Apache-2.0 |
| Semantic Layer | MetricFlow | Apache-2.0 |
| OCR Engine | PaddleOCR | Apache-2.0 |

### Frontend Stack

| Component | Technology | License |
|-----------|------------|---------|
| Web Framework | React 19.2.4 | MIT |
| Generative UI | CopilotKit | MIT |
| Charts | Apache ECharts | Apache-2.0 |
| Web i18n | i18next + react-i18next | MIT |
| Mobile | Flutter 3.42 | BSD-3 |

**Constraint:** No technology outside this approved stack may be introduced without
explicit justification and constitution amendment.

## Development Workflow & Quality Gates

### Pre-Commit Checklist

Before committing code, verify:

- [ ] AI agents use `medisync_readonly` DB role
- [ ] All SQL queries are validated as SELECT-only
- [ ] Write-back operations require HITL approval
- [ ] OPA policies cover new endpoints
- [ ] PII is masked based on user role
- [ ] All external API calls use TLS 1.3+
- [ ] Sensitive config is via environment variables
- [ ] Audit log entries are created for actions
- [ ] i18n keys exist in both `en/` and `ar/` locales

### Code Review Requirements

- All PRs MUST be reviewed by at least one team member
- Security-sensitive changes (auth, OPA, Tally sync) MUST be reviewed by tech lead
- PR description MUST reference the relevant spec or issue
- All CI checks MUST pass (tests, lint, i18n coverage, license check)

### Deployment Gates

- No deployment to production without passing all tests
- Database migrations MUST be tested on a copy of production data
- OPA policy changes MUST be reviewed and explicitly approved
- Tally sync operations require Finance Head role + HITL approval

## Governance

### Amendment Procedure

1. Propose amendment via pull request to `.specify/memory/constitution.md`
2. Document rationale and impact on existing code
3. Increment version according to semantic versioning:
   - **MAJOR**: Backward incompatible principle removals or redefinitions
   - **MINOR**: New principle/section added or materially expanded guidance
   - **PATCH**: Clarifications, wording, typo fixes
4. Require approval from tech lead and at least one other senior engineer
5. Update dependent templates and documentation after merge

### Compliance Review

- Constitution compliance is checked at every PR review
- Quarterly audit of codebase against constitution principles
- Violations MUST be documented in `plan.md` Complexity Tracking table with justification

### Runtime Guidance

For day-to-day development guidance, refer to `CLAUDE.md` which provides:
- Detailed code patterns and examples
- Agent development workflows
- Security implementation details
- i18n patterns and conventions
- Troubleshooting guides

**Version**: 1.0.0 | **Ratified**: 2026-02-19 | **Last Amended**: 2026-02-19
