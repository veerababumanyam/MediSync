openapi: 3.1.0
info:
  title: MediSync Alerts API
  description: |
    KPI alert management endpoints for monitoring metrics and receiving
    notifications when thresholds are crossed. Supports multi-channel
    delivery (in-app, email) with localized messages.

  version: 1.0.0
  contact:
    name: MediSync API Support
    email: api@medisync.health

servers:
  - url: /api/v1
    description: API v1

tags:
  - name: Alert Rules
    description: Alert configuration and management
  - name: Notifications
    description: In-app notification center

paths:
  /alerts/rules:
    get:
      summary: List alert rules
      description: Get all alert rules for the authenticated user
      operationId: listAlertRules
      tags:
        - Alert Rules
      security:
        - bearerAuth: []
      parameters:
        - name: is_active
          in: query
          schema:
            type: boolean
        - name: metric_category
          in: query
          schema:
            type: string
            enum: [revenue, inventory, patients, appointments, financial]
      responses:
        '200':
          description: List of alert rules
          content:
            application/json:
              schema:
                type: object
                properties:
                  rules:
                    type: array
                    items:
                      $ref: '#/components/schemas/AlertRule'
                  total:
                    type: integer

    post:
      summary: Create alert rule
      description: |
        Create a new alert rule to monitor a metric and notify when
        the threshold is crossed.
      operationId: createAlertRule
      tags:
        - Alert Rules
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateAlertRuleRequest'
            examples:
              low_stock:
                summary: Low inventory alert
                value:
                  name: "Low Stock Alert - Paracetamol"
                  description: "Alert when Paracetamol stock falls below 50 units"
                  metric_id: "inventory.paracetamol.quantity"
                  operator: "lt"
                  threshold: 50
                  check_interval: 300
                  channels: ["in_app", "email"]
                  cooldown_period: 3600
              revenue_drop:
                summary: Revenue drop alert
                value:
                  name: "Daily Revenue Below Target"
                  metric_id: "revenue.daily.total"
                  operator: "lt"
                  threshold: 10000
                  check_interval: 3600
                  channels: ["in_app"]
                  cooldown_period: 86400
      responses:
        '201':
          description: Alert rule created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AlertRule'
        '400':
          description: Invalid request
        '422':
          description: Invalid metric_id or threshold

  /alerts/rules/{rule_id}:
    get:
      summary: Get alert rule details
      operationId: getAlertRule
      tags:
        - Alert Rules
      security:
        - bearerAuth: []
      parameters:
        - name: rule_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Alert rule details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AlertRule'
        '404':
          description: Rule not found

    patch:
      summary: Update alert rule
      description: Update alert rule settings
      operationId: updateAlertRule
      tags:
        - Alert Rules
      security:
        - bearerAuth: []
      parameters:
        - name: rule_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateAlertRuleRequest'
      responses:
        '200':
          description: Alert rule updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AlertRule'
        '404':
          description: Rule not found

    delete:
      summary: Delete alert rule
      operationId: deleteAlertRule
      tags:
        - Alert Rules
      security:
        - bearerAuth: []
      parameters:
        - name: rule_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Rule deleted
        '404':
          description: Rule not found

  /alerts/rules/{rule_id}/toggle:
    post:
      summary: Toggle alert rule active state
      description: Enable or disable an alert rule
      operationId: toggleAlertRule
      tags:
        - Alert Rules
      security:
        - bearerAuth: []
      parameters:
        - name: rule_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - is_active
              properties:
                is_active:
                  type: boolean
      responses:
        '200':
          description: Rule state updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  is_active:
                    type: boolean

  /alerts/rules/{rule_id}/test:
    post:
      summary: Test alert rule
      description: |
        Trigger a test notification for the alert rule to verify
        configuration and delivery channels.
      operationId: testAlertRule
      tags:
        - Alert Rules
      security:
        - bearerAuth: []
      parameters:
        - name: rule_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Test notification sent
          content:
            application/json:
              schema:
                type: object
                properties:
                  notification_id:
                    type: string
                    format: uuid
                  channels:
                    type: array
                    items:
                      type: string
        '429':
          description: Test rate limit exceeded (max 3 per hour)

  /alerts/metrics:
    get:
      summary: List available metrics
      description: |
        Get list of metrics available for alert configuration.
        Used to populate metric selection dropdown.
      operationId: listAlertMetrics
      tags:
        - Alert Rules
      security:
        - bearerAuth: []
      parameters:
        - name: category
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Available metrics
          content:
            application/json:
              schema:
                type: object
                properties:
                  metrics:
                    type: array
                    items:
                      $ref: '#/components/schemas/Metric'

  /notifications:
    get:
      summary: List notifications
      description: Get notifications for the authenticated user
      operationId: listNotifications
      tags:
        - Notifications
      security:
        - bearerAuth: []
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [unread, read, all]
            default: unread
        - name: type
          in: query
          schema:
            type: string
            enum: [in_app, email]
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: before
          in: query
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: List of notifications
          content:
            application/json:
              schema:
                type: object
                properties:
                  notifications:
                    type: array
                    items:
                      $ref: '#/components/schemas/Notification'
                  unread_count:
                    type: integer
                  has_more:
                    type: boolean

  /notifications/{notification_id}/read:
    post:
      summary: Mark notification as read
      operationId: markNotificationRead
      tags:
        - Notifications
      security:
        - bearerAuth: []
      parameters:
        - name: notification_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Notification marked as read
        '404':
          description: Notification not found

  /notifications/read-all:
    post:
      summary: Mark all notifications as read
      operationId: markAllNotificationsRead
      tags:
        - Notifications
      security:
        - bearerAuth: []
      responses:
        '200':
          description: All notifications marked as read
          content:
            application/json:
              schema:
                type: object
                properties:
                  updated_count:
                    type: integer

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    AlertRule:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          maxLength: 100
        description:
          type: string
        metric_id:
          type: string
        metric_name:
          type: string
          description: Human-readable metric name (localized)
        operator:
          type: string
          enum: [gt, gte, lt, lte, eq]
        threshold:
          type: number
        check_interval:
          type: integer
          description: Evaluation interval in seconds
        channels:
          type: array
          items:
            type: string
            enum: [in_app, email]
        locale:
          type: string
          enum: [en, ar]
        cooldown_period:
          type: integer
          description: Minimum seconds between alerts
        last_triggered_at:
          type: string
          format: date-time
        last_value:
          type: number
        is_active:
          type: boolean
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CreateAlertRuleRequest:
      type: object
      required:
        - name
        - metric_id
        - operator
        - threshold
        - check_interval
        - channels
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
        description:
          type: string
          maxLength: 500
        metric_id:
          type: string
          description: Metric identifier from /alerts/metrics
        operator:
          type: string
          enum: [gt, gte, lt, lte, eq]
        threshold:
          type: number
        check_interval:
          type: integer
          minimum: 60
          maximum: 86400
          default: 300
          description: Evaluation interval in seconds
        channels:
          type: array
          minItems: 1
          items:
            type: string
            enum: [in_app, email]
        cooldown_period:
          type: integer
          minimum: 0
          maximum: 86400
          default: 3600

    UpdateAlertRuleRequest:
      type: object
      minProperties: 1
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
        description:
          type: string
          maxLength: 500
        threshold:
          type: number
        check_interval:
          type: integer
          minimum: 60
          maximum: 86400
        channels:
          type: array
          minItems: 1
          items:
            type: string
            enum: [in_app, email]
        cooldown_period:
          type: integer
          minimum: 0
          maximum: 86400
        is_active:
          type: boolean

    Metric:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
          description: Localized metric name
        category:
          type: string
          enum: [revenue, inventory, patients, appointments, financial]
        unit:
          type: string
          description: Unit of measurement (e.g., "USD", "units", "%")
        description:
          type: string

    Notification:
      type: object
      properties:
        id:
          type: string
          format: uuid
        alert_rule_id:
          type: string
          format: uuid
        type:
          type: string
          enum: [in_app, email]
        status:
          type: string
          enum: [pending, sent, delivered, failed]
        content:
          type: object
          properties:
            title:
              type: string
            message:
              type: string
            action_url:
              type: string
        locale:
          type: string
          enum: [en, ar]
        metric_value:
          type: number
        threshold:
          type: number
        sent_at:
          type: string
          format: date-time
        read_at:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time
