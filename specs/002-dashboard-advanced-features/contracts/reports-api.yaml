openapi: 3.1.0
info:
  title: MediSync Reports API
  description: |
    Scheduled report management endpoints for configuring recurring
    report generation and delivery. Supports PDF, spreadsheet, and CSV
    formats with full RTL Arabic support.

  version: 1.0.0
  contact:
    name: MediSync API Support
    email: api@medisync.health

servers:
  - url: /api/v1
    description: API v1

tags:
  - name: Scheduled Reports
    description: Report scheduling configuration
  - name: Report Runs
    description: Report execution history

paths:
  /reports/scheduled:
    get:
      summary: List scheduled reports
      description: Get all scheduled reports for the authenticated user
      operationId: listScheduledReports
      tags:
        - Scheduled Reports
      security:
        - bearerAuth: []
      parameters:
        - name: is_active
          in: query
          schema:
            type: boolean
        - name: format
          in: query
          schema:
            type: string
            enum: [pdf, xlsx, csv]
      responses:
        '200':
          description: List of scheduled reports
          content:
            application/json:
              schema:
                type: object
                properties:
                  reports:
                    type: array
                    items:
                      $ref: '#/components/schemas/ScheduledReport'
                  total:
                    type: integer

    post:
      summary: Create scheduled report
      description: |
        Configure a new recurring report. The report will be generated
        and delivered to recipients at the scheduled time.
      operationId: createScheduledReport
      tags:
        - Scheduled Reports
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateScheduledReportRequest'
            examples:
              weekly_revenue:
                summary: Weekly revenue report
                value:
                  name: "Weekly Revenue Summary"
                  description: "Weekly revenue breakdown by department"
                  natural_language_query: "Show me this week's revenue by department"
                  schedule_type: "weekly"
                  schedule_time: "07:00"
                  schedule_day: 1
                  recipients:
                    - email: "manager@clinic.com"
                      name: "Clinic Manager"
                  format: "pdf"
                  locale: "en"
                  include_charts: true
              monthly_arabic:
                summary: Monthly Arabic report
                value:
                  name: "التقرير المالي الشهري"
                  natural_language_query: "أعطني ملخص الإيرادات والمصروفات لهذا الشهر"
                  schedule_type: "monthly"
                  schedule_time: "08:00"
                  schedule_day: 1
                  recipients:
                    - email: "finance@clinic.ae"
                      name: "مدير المالية"
                  format: "xlsx"
                  locale: "ar"
                  include_charts: true
      responses:
        '201':
          description: Scheduled report created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScheduledReport'
        '400':
          description: Invalid request
        '422':
          description: Invalid schedule or query

  /reports/scheduled/{report_id}:
    get:
      summary: Get scheduled report details
      operationId: getScheduledReport
      tags:
        - Scheduled Reports
      security:
        - bearerAuth: []
      parameters:
        - name: report_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Scheduled report details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScheduledReport'
        '404':
          description: Report not found

    patch:
      summary: Update scheduled report
      description: Update report configuration
      operationId: updateScheduledReport
      tags:
        - Scheduled Reports
      security:
        - bearerAuth: []
      parameters:
        - name: report_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateScheduledReportRequest'
      responses:
        '200':
          description: Report updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScheduledReport'
        '404':
          description: Report not found

    delete:
      summary: Delete scheduled report
      operationId: deleteScheduledReport
      tags:
        - Scheduled Reports
      security:
        - bearerAuth: []
      parameters:
        - name: report_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Report deleted
        '404':
          description: Report not found

  /reports/scheduled/{report_id}/toggle:
    post:
      summary: Toggle report active state
      description: Enable or disable a scheduled report
      operationId: toggleScheduledReport
      tags:
        - Scheduled Reports
      security:
        - bearerAuth: []
      parameters:
        - name: report_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - is_active
              properties:
                is_active:
                  type: boolean
      responses:
        '200':
          description: Report state updated

  /reports/scheduled/{report_id}/run:
    post:
      summary: Trigger immediate report run
      description: |
        Generate and deliver the report immediately, outside the normal schedule.
        Useful for testing or on-demand delivery.
      operationId: runScheduledReport
      tags:
        - Scheduled Reports
      security:
        - bearerAuth: []
      parameters:
        - name: report_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '202':
          description: Report run initiated
          content:
            application/json:
              schema:
                type: object
                properties:
                  run_id:
                    type: string
                    format: uuid
                  estimated_time_seconds:
                    type: integer
        '429':
          description: Run rate limit exceeded

  /reports/scheduled/{report_id}/runs:
    get:
      summary: Get report run history
      description: View execution history for a scheduled report
      operationId: getReportRuns
      tags:
        - Report Runs
      security:
        - bearerAuth: []
      parameters:
        - name: report_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, running, completed, failed]
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 20
      responses:
        '200':
          description: Report run history
          content:
            application/json:
              schema:
                type: object
                properties:
                  runs:
                    type: array
                    items:
                      $ref: '#/components/schemas/ReportRun'
                  total:
                    type: integer

  /reports/runs/{run_id}:
    get:
      summary: Get report run details
      description: Get details of a specific report execution
      operationId: getReportRun
      tags:
        - Report Runs
      security:
        - bearerAuth: []
      parameters:
        - name: run_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Report run details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReportRun'
        '404':
          description: Run not found

  /reports/runs/{run_id}/download:
    get:
      summary: Download report file
      description: Download the generated report file
      operationId: downloadReport
      tags:
        - Report Runs
      security:
        - bearerAuth: []
      parameters:
        - name: run_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Report file
          content:
            application/pdf:
              schema:
                type: string
                format: binary
            application/vnd.openxmlformats-officedocument.spreadsheetml.sheet:
              schema:
                type: string
                format: binary
            text/csv:
              schema:
                type: string
        '404':
          description: File not found or run not completed
        '410':
          description: File expired (retention: 30 days)

  /reports/templates:
    get:
      summary: List report templates
      description: |
        Get pre-built report templates available for quick scheduling.
        Templates include common healthcare BI reports.
      operationId: listReportTemplates
      tags:
        - Scheduled Reports
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Report templates
          content:
            application/json:
              schema:
                type: object
                properties:
                  templates:
                    type: array
                    items:
                      $ref: '#/components/schemas/ReportTemplate'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    ScheduledReport:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          maxLength: 150
        description:
          type: string
        natural_language_query:
          type: string
        schedule_type:
          type: string
          enum: [daily, weekly, monthly, quarterly]
        schedule_time:
          type: string
          pattern: '^([01]?[0-9]|2[0-3]):[0-5][0-9]$'
          description: Time in HH:MM format (24-hour)
        schedule_day:
          type: integer
          minimum: 1
          maximum: 31
          description: |
            Day interpretation depends on schedule_type:
            - daily: ignored
            - weekly: 1-7 (Monday-Sunday)
            - monthly: 1-31
            - quarterly: 1 (first day of quarter)
        recipients:
          type: array
          items:
            type: object
            required:
              - email
            properties:
              email:
                type: string
                format: email
              name:
                type: string
        format:
          type: string
          enum: [pdf, xlsx, csv]
        locale:
          type: string
          enum: [en, ar]
        include_charts:
          type: boolean
        last_run_at:
          type: string
          format: date-time
        next_run_at:
          type: string
          format: date-time
        last_run_status:
          type: string
          enum: [pending, running, completed, failed]
        is_active:
          type: boolean
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CreateScheduledReportRequest:
      type: object
      required:
        - name
        - natural_language_query
        - schedule_type
        - schedule_time
        - recipients
        - format
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 150
        description:
          type: string
          maxLength: 1000
        natural_language_query:
          type: string
          minLength: 10
          maxLength: 2000
        schedule_type:
          type: string
          enum: [daily, weekly, monthly, quarterly]
        schedule_time:
          type: string
          pattern: '^([01]?[0-9]|2[0-3]):[0-5][0-9]$'
        schedule_day:
          type: integer
          minimum: 1
          maximum: 31
        recipients:
          type: array
          minItems: 1
          items:
            type: object
            required:
              - email
            properties:
              email:
                type: string
                format: email
              name:
                type: string
        format:
          type: string
          enum: [pdf, xlsx, csv]
        locale:
          type: string
          enum: [en, ar]
        include_charts:
          type: boolean
          default: true

    UpdateScheduledReportRequest:
      type: object
      minProperties: 1
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 150
        description:
          type: string
          maxLength: 1000
        schedule_type:
          type: string
          enum: [daily, weekly, monthly, quarterly]
        schedule_time:
          type: string
          pattern: '^([01]?[0-9]|2[0-3]):[0-5][0-9]$'
        schedule_day:
          type: integer
          minimum: 1
          maximum: 31
        recipients:
          type: array
          minItems: 1
          items:
            type: object
            required:
              - email
            properties:
              email:
                type: string
                format: email
              name:
                type: string
        format:
          type: string
          enum: [pdf, xlsx, csv]
        locale:
          type: string
          enum: [en, ar]
        include_charts:
          type: boolean
        is_active:
          type: boolean

    ReportRun:
      type: object
      properties:
        id:
          type: string
          format: uuid
        report_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [pending, running, completed, failed]
        file_size_bytes:
          type: integer
        row_count:
          type: integer
        error_message:
          type: string
        started_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
        download_expires_at:
          type: string
          format: date-time
          description: When the download link expires

    ReportTemplate:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
          description: Localized template name
        description:
          type: string
        category:
          type: string
          enum: [financial, operational, clinical, inventory]
        default_query:
          type: string
        default_format:
          type: string
          enum: [pdf, xlsx, csv]
        has_chart:
          type: boolean
