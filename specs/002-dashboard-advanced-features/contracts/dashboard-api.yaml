openapi: 3.1.0
info:
  title: MediSync Dashboard API
  description: |
    Dashboard management endpoints for pinned charts and user preferences.
    Supports RTL layout and Arabic localization.

  version: 1.0.0
  contact:
    name: MediSync API Support
    email: api@medisync.health

servers:
  - url: /api/v1
    description: API v1

tags:
  - name: Dashboard
    description: Pinned chart management
  - name: Preferences
    description: User preference settings

paths:
  /dashboard/charts:
    get:
      summary: List pinned charts
      description: Get all pinned charts for the authenticated user's dashboard
      operationId: listPinnedCharts
      tags:
        - Dashboard
      security:
        - bearerAuth: []
      parameters:
        - name: include_inactive
          in: query
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: List of pinned charts
          content:
            application/json:
              schema:
                type: object
                properties:
                  charts:
                    type: array
                    items:
                      $ref: '#/components/schemas/PinnedChart'
                  grid_columns:
                    type: integer
                    description: Maximum columns in dashboard grid
                    example: 3
        '401':
          description: Authentication required

    post:
      summary: Pin chart to dashboard
      description: |
        Save a chart from a chat response to the user's dashboard.
        The chart will auto-refresh based on refresh_interval.
      operationId: pinChart
      tags:
        - Dashboard
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PinChartRequest'
            examples:
              pin_from_chat:
                summary: Pin chart from chat message
                value:
                  message_id: "660e8400-e29b-41d4-a716-446655440001"
                  title: "Monthly Revenue by Department"
                  refresh_interval: 300
      responses:
        '201':
          description: Chart pinned successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PinnedChart'
        '400':
          description: Invalid request
        '409':
          description: Maximum pinned charts reached (limit: 20)

  /dashboard/charts/{chart_id}:
    get:
      summary: Get pinned chart details
      description: Retrieve a specific pinned chart with current data
      operationId: getPinnedChart
      tags:
        - Dashboard
      security:
        - bearerAuth: []
      parameters:
        - name: chart_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: refresh
          in: query
          description: Force data refresh before returning
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Pinned chart details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PinnedChart'
        '404':
          description: Chart not found

    patch:
      summary: Update pinned chart
      description: Update chart settings (title, position, refresh interval)
      operationId: updatePinnedChart
      tags:
        - Dashboard
      security:
        - bearerAuth: []
      parameters:
        - name: chart_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdatePinnedChartRequest'
      responses:
        '200':
          description: Chart updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PinnedChart'
        '404':
          description: Chart not found

    delete:
      summary: Remove pinned chart
      description: Remove a chart from the dashboard (soft delete)
      operationId: deletePinnedChart
      tags:
        - Dashboard
      security:
        - bearerAuth: []
      parameters:
        - name: chart_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Chart removed successfully
        '404':
          description: Chart not found

  /dashboard/charts/{chart_id}/refresh:
    post:
      summary: Refresh chart data
      description: Force immediate data refresh for a pinned chart
      operationId: refreshChart
      tags:
        - Dashboard
      security:
        - bearerAuth: []
      parameters:
        - name: chart_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Chart refreshed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  chart_id:
                    type: string
                    format: uuid
                  refreshed_at:
                    type: string
                    format: date-time
                  data_updated:
                    type: boolean
        '429':
          description: Refresh rate limit exceeded

  /dashboard/charts/reorder:
    post:
      summary: Reorder dashboard charts
      description: Update positions of multiple charts in a single request
      operationId: reorderCharts
      tags:
        - Dashboard
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                positions:
                  type: array
                  items:
                    type: object
                    required:
                      - chart_id
                      - position
                    properties:
                      chart_id:
                        type: string
                        format: uuid
                      position:
                        $ref: '#/components/schemas/ChartPosition'
            example:
              positions:
                - chart_id: "550e8400-e29b-41d4-a716-446655440001"
                  position:
                    row: 0
                    col: 0
                    size: 2
                - chart_id: "550e8400-e29b-41d4-a716-446655440002"
                  position:
                    row: 0
                    col: 2
                    size: 1
      responses:
        '200':
          description: Charts reordered successfully
        '400':
          description: Invalid position configuration

  /dashboard/quick-actions:
    get:
      summary: Get quick-action prompts
      description: |
        Retrieve the list of configurable quick-action prompts displayed
        in the chat interface. Prompts are localized based on user's locale.
      operationId: getQuickActions
      tags:
        - Dashboard
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Quick-action prompts
          content:
            application/json:
              schema:
                type: object
                properties:
                  prompts:
                    type: array
                    items:
                      $ref: '#/components/schemas/QuickAction'
                  locale:
                    type: string
                    enum: [en, ar]

    put:
      summary: Update quick-action prompts
      description: |
        Update the quick-action prompts configuration.
        Requires admin role.
      operationId: updateQuickActions
      tags:
        - Dashboard
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                prompts:
                  type: array
                  minItems: 1
                  maxItems: 10
                  items:
                    type: object
                    required:
                      - id
                      - translations
                    properties:
                      id:
                        type: string
                      translations:
                        type: object
                        properties:
                          en:
                            type: string
                          ar:
                            type: string
      responses:
        '200':
          description: Quick-actions updated
        '403':
          description: Admin role required

  /preferences:
    get:
      summary: Get user preferences
      description: Retrieve current user's display and locale preferences
      operationId: getUserPreferences
      tags:
        - Preferences
      security:
        - bearerAuth: []
      responses:
        '200':
          description: User preferences
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserPreferences'

    patch:
      summary: Update user preferences
      description: Update display and locale preferences
      operationId: updateUserPreferences
      tags:
        - Preferences
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              minProperties: 1
              properties:
                locale:
                  type: string
                  enum: [en, ar]
                numeral_system:
                  type: string
                  enum: [western, eastern_arabic]
                calendar_system:
                  type: string
                  enum: [gregorian, hijri]
                report_language:
                  type: string
                  enum: [en, ar]
                timezone:
                  type: string
                  description: IANA timezone identifier
            example:
              locale: "ar"
              numeral_system: "eastern_arabic"
              calendar_system: "gregorian"
      responses:
        '200':
          description: Preferences updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserPreferences'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    PinnedChart:
      type: object
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
          maxLength: 200
        chart_type:
          type: string
          enum: [bar, line, pie, table, kpi]
        chart_spec:
          type: object
          description: ECharts configuration
        natural_language_query:
          type: string
        refresh_interval:
          type: integer
          description: Refresh interval in seconds (0 = disabled)
        locale:
          type: string
          enum: [en, ar]
        position:
          $ref: '#/components/schemas/ChartPosition'
        last_refreshed_at:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time

    ChartPosition:
      type: object
      properties:
        row:
          type: integer
          minimum: 0
        col:
          type: integer
          minimum: 0
        size:
          type: integer
          enum: [1, 2, 3]
          description: Width multiplier

    PinChartRequest:
      type: object
      required:
        - message_id
        - title
      properties:
        message_id:
          type: string
          format: uuid
          description: Source message containing the chart
        title:
          type: string
          minLength: 1
          maxLength: 200
        refresh_interval:
          type: integer
          minimum: 0
          maximum: 3600
          default: 300
          description: Auto-refresh interval in seconds
        position:
          $ref: '#/components/schemas/ChartPosition'

    UpdatePinnedChartRequest:
      type: object
      minProperties: 1
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 200
        refresh_interval:
          type: integer
          minimum: 0
          maximum: 3600
        position:
          $ref: '#/components/schemas/ChartPosition'
        is_active:
          type: boolean

    QuickAction:
      type: object
      properties:
        id:
          type: string
        text:
          type: string
          description: Localized prompt text
        category:
          type: string
          enum: [revenue, inventory, patients, appointments, financial]
        icon:
          type: string
          description: Icon identifier

    UserPreferences:
      type: object
      properties:
        locale:
          type: string
          enum: [en, ar]
        numeral_system:
          type: string
          enum: [western, eastern_arabic]
        calendar_system:
          type: string
          enum: [gregorian, hijri]
        report_language:
          type: string
          enum: [en, ar]
        timezone:
          type: string
        updated_at:
          type: string
          format: date-time
