# MediSync Internationalization (i18n) Guide

Comprehensive guide for implementing English (LTR) and Arabic (RTL) support in MediSync.

## Overview

MediSync supports two languages from Phase 1:
- **English (en)**: Left-to-right (LTR) layout
- **Arabic (ar)**: Right-to-left (RTL) layout

This is a non-negotiable requirement—every feature must work in both languages.

## Locale Detection Priority

The system determines the user's locale in this order:

1. **User Preference**: `user_preferences.locale` from database (stored in JWT)
2. **HTTP Header**: `Accept-Language` header
3. **URL Parameter**: `?lang=ar` or `?lang=en`
4. **Default**: `en` (English)

### Implementation Pattern (Go)

```go
func (s *Service) DetectLocale(ctx context.Context, userPrefs *UserPrefs, header string, param string) string {
    // 1. Check user preference
    if userPrefs != nil && userPrefs.Locale != "" {
        return userPrefs.Locale
    }

    // 2. Check URL parameter
    if param != "" && isValidLocale(param) {
        return param
    }

    // 3. Parse Accept-Language header
    if header != "" {
        if locales := parseAcceptLanguage(header); len(locales) > 0 {
            return locales[0]
        }
    }

    // 4. Default to English
    return "en"
}

func isValidLocale(locale string) bool {
    return locale == "en" || locale == "ar"
}
```

### Middleware Pattern

```go
func LocaleMiddleware(next http.Handler) http.Handler {
    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        // Extract from URL param
        locale := r.URL.Query().Get("lang")

        // Extract from header
        if locale == "" {
            locale = r.Header.Get("Accept-Language")
        }

        // Validate
        if locale != "en" && locale != "ar" {
            locale = "en"
        }

        // Add to context
        ctx := context.WithValue(r.Context(), "locale", locale)
        next.ServeHTTP(w, r.WithContext(ctx))
    })
}
```

## AI Prompt Localization

All AI agent prompts must include locale instructions:

```go
func (s *AgentService) buildPrompt(query, locale string) string {
    basePrompt := `You are an AI assistant for MediSync healthcare BI.`

    localeInstruction := fmt.Sprintf(`
ResponseLanguageInstruction:
- Respond in %s
- Format all numbers according to %s locale conventions
- For dates, use %s format
- For currency, use appropriate symbols and placement
`,
        getLanguageName(locale),
        locale,
        getDateFormat(locale),
    )

    return basePrompt + localeInstruction + "\n\nUser Query: " + query
}

func getLanguageName(locale string) string {
    switch locale {
    case "ar":
        return "Arabic"
    default:
        return "English"
    }
}

func getDateFormat(locale string) string {
    switch locale {
    case "ar":
        return "DD/MM/YYYY (Hijri calendar when relevant)"
    default:
        return "MM/DD/YYYY"
    }
}
```

## Frontend i18n (React)

### Using i18next

```tsx
import { useTranslation } from 'react-i18next';

function Dashboard() {
    const { t, i18n } = useTranslation();

    const changeLanguage = (lng: string) => {
        i18n.changeLanguage(lng);
        // Also trigger RTL layout change
        document.documentElement.dir = lng === 'ar' ? 'rtl' : 'ltr';
    };

    return (
        <div>
            <h1>{t('dashboard.title')}</h1>
            <p>{t('dashboard.welcome', { name: user.name })}</p>

            <button onClick={() => changeLanguage('en')}>English</button>
            <button onClick={() => changeLanguage('ar')}>العربية</button>
        </div>
    );
}
```

### RTL Layout with Tailwind CSS

Use logical properties for RTL-aware layouts:

```tsx
// Instead of ml-4 (margin-left)
<div className="ms-4">...</div>  // margin-start (respects RTL)

// Instead of mr-2 (margin-right)
<div className="me-2">...</div>  // margin-end

// Instead of pl-6 (padding-left)
<div className="ps-6">...</div>  // padding-start

// Text alignment
<div className="text-start">...</div>  // aligns left in LTR, right in RTL
```

### Translation File Structure

```
frontend/public/locales/
├── en/
│   ├── common.json
│   ├── dashboard.json
│   └── agents.json
└── ar/
    ├── common.json
    ├── dashboard.json
    └── agents.json
```

### Example Translation Files

**en/common.json**
```json
{
    "welcome": "Welcome to MediSync",
    "logout": "Logout",
    "search": "Search",
    "loading": "Loading...",
    "error": "An error occurred"
}
```

**ar/common.json**
```json
{
    "welcome": "مرحباً بك في MediSync",
    "logout": "تسجيل الخروج",
    "search": "بحث",
    "loading": "جاري التحميل...",
    "error": "حدث خطأ"
}
```

## Mobile i18n (Flutter)

### ARB Files

```
mobile/lib/l10n/
├── app_en.arb
├── app_ar.arb
└── app_localizations.dart
```

**app_en.arb**
```json
{
    "dashboardTitle": "MediSync Dashboard",
    "searchPlaceholder": "Search your data...",
    "@searchPlaceholder": {
        "type": "text"
    }
}
```

**app_ar.arb**
```json
{
    "dashboardTitle": "لوحة معلومات MediSync",
    "searchPlaceholder": "ابحث في بياناتك..."
}
```

### Using Localizations in Flutter

```dart
import 'package:flutter_gen/gen_l10n/app_localizations.dart';

class Dashboard extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context)!;

    return Scaffold(
      appBar: AppBar(
        title: Text(l10n.dashboardTitle),
      ),
      body: TextField(
        decoration: InputDecoration(
          hintText: l10n.searchPlaceholder,
        ),
      ),
    );
  }
}
```

### RTL Direction in Flutter

```dart
MaterialApp(
  localizationsDelegates: AppLocalizations.localizationsDelegates,
  supportedLocales: AppLocalizations.supportedLocales,
  locale: Locale('ar'), // or 'en'
  // Directionality is handled automatically based on locale
);
```

## Number Formatting

### Go Backend

```go
import "golang.org/x/text/message"

func formatNumber(num float64, locale string) string {
    p := message.NewPrinter(language.Make(locale))
    return p.Printf("%f", num)
}

func formatCurrency(amount float64, locale string, currency string) string {
    p := message.NewPrinter(language.Make(locale))
    switch currency {
    case "SAR", "AED":
        return p.Sprintf("%s %.2f", currency, amount)
    case "USD":
        return p.Sprintf("%.2f %s", amount, currency)
    default:
        return p.Sprintf("%.2f %s", amount, currency)
    }
}
```

### React Frontend

```tsx
import { Intl } from 'react-intl' // or use intlNumberFormat from i18next

function Amount({ value, currency, locale }) {
    return new Intl.NumberFormat(locale, {
        style: 'currency',
        currency: currency,
    }).format(value);
}

// Usage:
// <Amount value={1234.56} currency="SAR" locale="ar" />
// Output: "١٬٢٣٤٫٥٦ ر.س" (Arabic numerals)
```

### Arabic Numeral Conversion

```typescript
function toArabicNumerals(num: number): string {
    const arabicNumerals = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
    return num.toString().replace(/\d/g, d => arabicNumerals[parseInt(d)]);
}

// toArabicNumerals(1234) → "١٢٣٤"
```

## Date Formatting

### Go Backend

```go
import "golang.org/x/text/message"

func formatDate(date time.Time, locale string) string {
    p := message.NewPrinter(language.Make(locale))

    switch locale {
    case "ar":
        // For Arabic, may show Hijri calendar alongside
        gregorian := date.Format("02/01/2006")
        hijri := toHijri(date)  // Requires Hijri calendar library
        return fmt.Sprintf("%s (%s)", gregorian, hijri)
    default:
        return date.Format("01/02/2006")
    }
}
```

### React Frontend

```tsx
import { format } from 'date-fns';
import { ar, enUS } from 'date-fns/locale';

function FormattedDate({ date, locale }) {
    const dateLocale = locale === 'ar' ? ar : enUS;
    return format(date, 'PPP', { locale: dateLocale });
}

// Output for "ar": "١٩ فبراير ٢٠٢٦"
// Output for "en": "February 19, 2026"
```

## Translation Key Naming Convention

Use hierarchical keys with dots:

```
feature.entity.action
```

Examples:
- `dashboard.patients.list` - List patients button
- `agents.text2sql.placeholder` - Text-to-SQL input placeholder
- `approval.workflow.submit` - Submit approval button
- `tally.sync.status.pending` - Sync status text

## Common Patterns

### Conditional Direction

```tsx
<div dir={locale === 'ar' ? 'rtl' : 'ltr'}>
    {/* Content that needs explicit direction */}
</div>
```

### Mirroring Icons

```tsx
// Icons that imply direction may need to be mirrored in RTL
const ChevronIcon = ({ locale }) => (
    <svg
        className={locale === 'ar' ? 'scale-x-[-1]' : ''}
        // or use: transform: scaleX(-1) for Arabic
    >
        <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z" />
    </svg>
);
```

### Text Alignment

```tsx
// Use logical properties
<div className="text-start">...</div>  // Not text-left or text-right

// For specific alignment needs
<div dir="ltr" className="text-right">...</div>  // Force LTR with right align
```

## Testing i18n

### Test Both Locales

```typescript
describe('Dashboard', () => {
    it('renders in English', () => {
        render(<Dashboard />, { locale: 'en' });
        expect(screen.getByText('Welcome')).toBeInTheDocument();
    });

    it('renders in Arabic', () => {
        render(<Dashboard />, { locale: 'ar' });
        expect(screen.getByText('مرحباً')).toBeInTheDocument();
        expect(document.documentElement.dir).toBe('rtl');
    });
});
```

### Verify Translation Completeness

Add CI check to ensure all keys exist in both locales:

```yaml
# .github/workflows/i18n-check.yml
- name: Check i18n completeness
  run: |
    en_keys=$(jq 'keys' frontend/public/locales/en/common.json | sort)
    ar_keys=$(jq 'keys' frontend/public/locales/ar/common.json | sort)
    if [ "$en_keys" != "$ar_keys" ]; then
      echo "Translation keys mismatch!"
      exit 1
    fi
```

## Checklist for New Features

When adding new features:

- [ ] All user-facing strings in translation files
- [ ] Both `en` and `ar` translations provided
- [ ] RTL layout tested for Arabic
- [ ] Numbers formatted according to locale
- [ ] Dates formatted according to locale
- [ ] Currency symbols and placement correct
- [ ] Directional icons properly mirrored
- [ ] AI prompts include locale instruction
- [ ] Tests cover both locales
