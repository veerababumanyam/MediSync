# MediSync Development Environment
# Docker Compose configuration for local development
#
# Services:
#   - postgres: PostgreSQL 16 with pgvector extension (data warehouse)
#   - nats: NATS server with JetStream for event streaming
#   - redis: Redis for caching and session storage
#   - keycloak: Keycloak for authentication and authorization
#   - etl: ETL service for Tally and HIMS data synchronization
#
# Usage:
#   docker-compose up -d        # Start all services
#   docker-compose down         # Stop all services
#   docker-compose logs -f      # View logs
#   docker-compose ps           # Check service status
#
# Note: PostgreSQL 18.2 is not yet available; using PostgreSQL 16 with pgvector as stable alternative

services:
  # ============================================================================
  # PostgreSQL - Primary Data Warehouse
  # ============================================================================
  # Using pgvector-enabled image for vector similarity search
  # Schemas: hims_analytics, tally_analytics, app, vectors
  postgres:
    image: pgvector/pgvector:pg16
    container_name: medisync-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-medisync}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-medisync_dev_password}
      POSTGRES_DB: ${POSTGRES_DB:-medisync}
      # Performance tuning for development
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=en_US.UTF-8"
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      # Persistent data volume
      - postgres_data:/var/lib/postgresql/data
      # Custom PostgreSQL configuration
      - ./deployments/postgres/postgresql.conf:/etc/postgresql/postgresql.conf:ro
      # Initialization scripts (run in alphabetical order)
      - ./deployments/postgres/init:/docker-entrypoint-initdb.d:ro
    command: >
      postgres -c shared_preload_libraries=pg_stat_statements -c pg_stat_statements.track=all -c log_statement=all -c log_min_duration_statement=100 -c shared_buffers=256MB -c effective_cache_size=768MB -c maintenance_work_mem=128MB -c work_mem=16MB -c max_connections=100
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-medisync} -d ${POSTGRES_DB:-medisync}" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - medisync-network
    labels:
      - "com.medisync.service=database"
      - "com.medisync.description=PostgreSQL data warehouse with pgvector"

  # ============================================================================
  # NATS - Event Streaming with JetStream
  # ============================================================================
  # Used for:
  #   - ETL sync events (etl.sync.completed, etl.sync.failed)
  #   - Agent communication
  #   - Real-time notifications
  nats:
    image: nats:2.10-alpine
    container_name: medisync-nats
    restart: unless-stopped
    ports:
      # Client connections
      - "${NATS_PORT:-4222}:4222"
      # HTTP monitoring
      - "${NATS_MONITOR_PORT:-8222}:8222"
      # Cluster routing (for future multi-node setup)
      - "${NATS_CLUSTER_PORT:-6222}:6222"
    volumes:
      # NATS configuration
      - ./deployments/nats/nats.conf:/etc/nats/nats.conf:ro
      # JetStream storage
      - nats_data:/data
    command: [ "-c", "/etc/nats/nats.conf" ]
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:8222/healthz" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - medisync-network
    labels:
      - "com.medisync.service=messaging"
      - "com.medisync.description=NATS JetStream for event streaming"

  # ============================================================================
  # Redis - Caching and Session Storage
  # ============================================================================
  # Used for:
  #   - Schema context caching (1h TTL)
  #   - Session storage
  #   - Rate limiting
  #   - Temporary data
  redis:
    image: redis:7-alpine
    container_name: medisync-redis
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      # Persistent data (optional for dev, recommended)
      - redis_data:/data
      # Custom Redis configuration
      - ./deployments/redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    command: [ "redis-server", "/usr/local/etc/redis/redis.conf" ]
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - medisync-network
    labels:
      - "com.medisync.service=cache"
      - "com.medisync.description=Redis cache and session storage"

  # ============================================================================
  # Keycloak - Identity and Access Management
  # ============================================================================
  # Provides:
  #   - User authentication (OAuth2/OIDC)
  #   - Role-based access control
  #   - JWT token issuance
  keycloak:
    image: quay.io/keycloak/keycloak:23.0
    container_name: medisync-keycloak
    restart: unless-stopped
    environment:
      # Admin credentials (change in production!)
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin_dev_password}
      # Database connection (using embedded H2 for dev, use Postgres for prod)
      KC_DB: dev-file
      # Hostname configuration
      KC_HOSTNAME: localhost
      KC_HOSTNAME_STRICT: "false"
      KC_HOSTNAME_STRICT_HTTPS: "false"
      # HTTP settings (HTTPS disabled for local dev)
      KC_HTTP_ENABLED: "true"
      KC_HTTP_PORT: "8180"
      KC_HEALTH_ENABLED: "true"
      KC_METRICS_ENABLED: "true"
      # Logging
      KC_LOG_LEVEL: INFO
    ports:
      - "${KEYCLOAK_PORT:-8180}:8180"
    volumes:
      # Realm configuration (auto-imported on startup)
      - ./deployments/keycloak:/opt/keycloak/data/import:ro
      # Persistent data
      - keycloak_data:/opt/keycloak/data
    command: [ "start-dev", "--import-realm" ]
    healthcheck:
      test: [ "CMD-SHELL", "exec 3<>/dev/tcp/localhost/8180 && echo -e 'GET /health/ready HTTP/1.1\\r\\nHost: localhost\\r\\n\\r\\n' >&3 && cat <&3 | grep -q '200 OK'" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - medisync-network
    labels:
      - "com.medisync.service=auth"
      - "com.medisync.description=Keycloak identity provider"

  # ============================================================================
  # ETL Service - Data Synchronization
  # ============================================================================
  # Syncs data from:
  #   - Tally ERP (financial data, ledgers, vouchers)
  #   - HIMS (patient data, appointments, billing, pharmacy)
  # Publishes events to NATS for downstream processing
  etl:
    build:
      context: .
      dockerfile: cmd/etl/Dockerfile
    image: medisync-etl:latest
    container_name: medisync-etl
    restart: unless-stopped
    environment:
      # Database connection
      DATABASE_URL: postgres://${POSTGRES_USER:-medisync}:${POSTGRES_PASSWORD:-medisync_dev_password}@postgres:5432/${POSTGRES_DB:-medisync}?sslmode=disable
      # NATS connection
      NATS_URL: nats://nats:4222
      # Redis connection
      REDIS_URL: redis://redis:6379/0
      # Tally ERP connection (configure with actual values)
      TALLY_HOST: ${TALLY_HOST:-localhost}
      TALLY_PORT: ${TALLY_PORT:-9000}
      # HIMS API connection (configure with actual values)
      HIMS_API_URL: http://host.docker.internal:8082/api
      HIMS_API_KEY: ${HIMS_API_KEY:-}
      # Logging configuration
      LOG_LEVEL: ${LOG_LEVEL:-info}
      LOG_FORMAT: json
      # ETL configuration
      ETL_SYNC_INTERVAL: ${ETL_SYNC_INTERVAL:-5m}
      ETL_BATCH_SIZE: ${ETL_BATCH_SIZE:-1000}
      # Metrics
      METRICS_PORT: "9100"
    ports:
      # Prometheus metrics endpoint
      - "${ETL_METRICS_PORT:-9100}:9100"
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - medisync-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    labels:
      - "com.medisync.service=etl"
      - "com.medisync.description=ETL service for Tally and HIMS data sync"

  # ============================================================================
  # Prometheus - Metrics Collection (Optional)
  # ============================================================================
  prometheus:
    image: prom/prometheus:v2.49.0
    container_name: medisync-prometheus
    restart: unless-stopped
    profiles:
      - monitoring
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    volumes:
      - ./deployments/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=7d"
      - "--web.enable-lifecycle"
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:9090/-/healthy" ]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - medisync-network
    labels:
      - "com.medisync.service=monitoring"
      - "com.medisync.description=Prometheus metrics server"

  # ============================================================================
  # Grafana - Dashboards and Visualization (Optional)
  # ============================================================================
  grafana:
    image: grafana/grafana:10.3.0
    container_name: medisync-grafana
    restart: unless-stopped
    profiles:
      - monitoring
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin_dev_password}
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_SERVER_HTTP_PORT: "3001"
    ports:
      - "${GRAFANA_PORT:-3001}:3001"
    volumes:
      - ./deployments/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./deployments/grafana/dashboards:/var/lib/grafana/dashboards:ro
      - grafana_data:/var/lib/grafana
    depends_on:
      - prometheus
    healthcheck:
      test: [ "CMD-SHELL", "wget --spider -q http://localhost:3001/api/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - medisync-network
    labels:
      - "com.medisync.service=dashboards"
      - "com.medisync.description=Grafana visualization"

# ============================================================================
# Networks
# ============================================================================
networks:
  medisync-network:
    name: medisync-network
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# ============================================================================
# Volumes
# ============================================================================
volumes:
  postgres_data:
    name: medisync-postgres-data
  nats_data:
    name: medisync-nats-data
  redis_data:
    name: medisync-redis-data
  keycloak_data:
    name: medisync-keycloak-data
  prometheus_data:
    name: medisync-prometheus-data
  grafana_data:
    name: medisync-grafana-data
